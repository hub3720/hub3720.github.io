<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Web Flight Sim Engine</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #FFF; pointer-events: none; text-shadow: 2px 2px 4px #000; z-index: 10; }
        .info { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        #joy-wrapper { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #FFF; touch-action: none; z-index: 10; }
        #joy-stick { position: absolute; width: 50px; height: 50px; background: #FFF; border-radius: 50%; top: 45px; left: 45px; }
        .thr-box { position: absolute; bottom: 30px; left: 200px; display: flex; flex-direction: column; align-items: center; color: #FFF; z-index: 10; }
        input[type=range] { -webkit-appearance: slider-vertical; width: 30px; height: 140px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="info" id="ui-spd">SPEED: 0 kts</div>
        <div class="info" id="ui-alt">ALTITUDE: 0 m</div>
    </div>

    <div class="thr-box"><b>THR</b><input type="range" id="input-thr" min="0" max="1" step="0.01" value="0"></div>
    <div id="joy-wrapper"><div id="joy-stick"></div></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js",
                "3d-tiles-renderer": "https://unpkg.com/3d-tiles-renderer@0.3.26/build/index.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';
        import { TilesRenderer } from '3d-tiles-renderer';

        // --- KEYS ---
        const GOOGLE_API_KEY = "SUA_CHAVE_AQUI"; // Pegue no Google Cloud (Map Tiles API)
        const BING_KEY = "SUA_CHAVE_AQUI";       // Pegue no Bing Maps Portal

        // --- CONSTANTES ---
        const LAT = -22.9105; // Santos Dumont
        const LON = -43.1631;
        const EARTH_RADIUS = 6378137; 

        const scene = new THREE.Scene();
        const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000000);
        
        // --- GRUPO DO MUNDO (O "PLANETA") ---
        const worldGroup = new THREE.Group();
        scene.add(worldGroup);

        // --- GOOGLE 3D TILES (O TERRENO 3D) ---
        const tiles = new TilesRenderer(`https://tile.googleapis.com/v1/3dtiles/root.json?key=${GOOGLE_API_KEY}`);
        tiles.setCamera(camera);
        tiles.setResolutionFromRenderer(camera, renderer);
        worldGroup.add(tiles.group);

        // --- BING MAPS (TEXTURA DO GLOBO PARA O HORIZONTE) ---
        // Aqui criamos uma esfera gigante que serve de fundo para onde não tem 3D do Google
        const globeGeo = new THREE.SphereGeometry(EARTH_RADIUS - 10, 64, 64);
        const globeMat = new THREE.MeshStandardMaterial();
        const globe = new THREE.Mesh(globeGeo, globeMat);
        worldGroup.add(globe);

        // Carrega um tile de satélite do Bing para o globo base
        const bingLoader = new THREE.TextureLoader();
        globeMat.map = bingLoader.load(`https://ecn.t0.tiles.virtualearth.net/tiles/a0.jpeg?g=1&key=${BING_KEY}`);

        // --- POSICIONAMENTO ECEF (Matemática GeoFS) ---
        function setWorldToLocation(lat, lon) {
            const phi = lat * (Math.PI / 180);
            const theta = (lon + 90) * (Math.PI / 180);

            const x = EARTH_RADIUS * Math.cos(phi) * Math.sin(theta);
            const y = EARTH_RADIUS * Math.sin(phi);
            const z = EARTH_RADIUS * Math.cos(phi) * Math.cos(theta);

            // Move o mundo para que a coordenada esteja no 0,0,0 do Three.js
            worldGroup.position.set(-x, -y, -z);
            
            // Rotaciona o planeta para que o chão fique "reto" (para cima)
            worldGroup.rotation.x = phi;
            worldGroup.rotation.y = -theta + Math.PI/2;
        }

        setWorldToLocation(LAT, LON);

        // --- AVIÃO ---
        const planeGroup = new THREE.Group();
        scene.add(planeGroup);
        planeGroup.position.set(0, 2, 0); // Altura na pista

        let speed = 0, thr = 0, joy = { x: 0, y: 0 };
        new GLTFLoader().load('1.glb', (gltf) => {
            gltf.scene.rotation.y = Math.PI;
            planeGroup.add(gltf.scene);
        });

        // --- LUZ E CÉU ---
        const sun = new THREE.DirectionalLight(0xffffff, 2);
        sun.position.set(1000, 2000, 1000);
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // --- CONTROLES ---
        const stick = document.getElementById('joy-stick'), wrap = document.getElementById('joy-wrapper');
        wrap.onpointermove = (e) => {
            if (e.buttons === 1) {
                const r = wrap.getBoundingClientRect();
                joy.x = (e.clientX - r.left - 70) / 70;
                joy.y = (e.clientY - r.top - 70) / 70;
                stick.style.transform = `translate(${joy.x * 50}px, ${joy.y * 50}px)`;
            }
        };
        wrap.onpointerup = () => { joy = { x: 0, y: 0 }; stick.style.transform = `translate(0,0)`; };
        document.getElementById('input-thr').oninput = (e) => thr = parseFloat(e.target.value);

        const clock = new THREE.Clock();

        function loop() {
            const dt = clock.getDelta();
            
            // Física de Voo Básica
            speed = THREE.MathUtils.lerp(speed, thr * 300, dt * 0.2);
            
            if (speed > 50) {
                planeGroup.rotation.x = THREE.MathUtils.lerp(planeGroup.rotation.x, joy.y * 0.6, dt);
                planeGroup.rotation.z = THREE.MathUtils.lerp(planeGroup.rotation.z, -joy.x * 0.8, dt);
                planeGroup.rotation.y -= planeGroup.rotation.z * dt * 0.5;
            }

            // O Segredo: Movemos o MUNDO, não o avião
            const moveDir = new THREE.Vector3(0, 0, 1).applyQuaternion(planeGroup.quaternion);
            worldGroup.position.add(moveDir.multiplyScalar(-speed * dt));

            // Gravidade/Sustentação básica
            const lift = (speed / 150) * (1 + planeGroup.rotation.x);
            worldGroup.position.y -= (1.0 - lift) * 9.8 * dt;

            // Update Tiles
            tiles.update();

            // Câmera Chase
            const camPos = new THREE.Vector3(0, 8, -25).applyQuaternion(planeGroup.quaternion).add(planeGroup.position);
            camera.position.lerp(camPos, 0.1);
            camera.lookAt(planeGroup.position);

            document.getElementById('ui-spd').innerText = `SPEED: ${Math.round(speed)} kts`;

            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
    </html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PokéMMO Avançado</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
<script src="https://cdn.jsdelivr.net/npm/colyseus.js@0.15.0/dist/colyseus.js"></script>
<style>
body { margin:0; padding:0; overflow:hidden; background:#000; }
canvas { display:block; margin:0 auto; }
#chat { position:fixed; bottom:0; width:100%; display:flex; gap:4px; padding:4px; background:rgba(0,0,0,0.5); }
#chat input { flex:1; padding:6px; border-radius:4px; border:none; }
#chat button { padding:6px 10px; border-radius:4px; border:none; background:#66ccff; color:#001; font-weight:700; cursor:pointer; }
#messages { position:fixed; bottom:50px; left:4px; max-width:70%; color:#fff; font-family:Arial, sans-serif; font-size:14px; overflow:auto; max-height:40vh; }
</style>
</head>
<body>

<div id="messages"></div>
<div id="chat">
<input type="text" id="chatInput" placeholder="Escreva algo..."/>
<button id="chatSend">Enviar</button>
</div>

<script>
let config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default:'arcade', arcade:{ debug:false } },
    scene: { preload, create, update }
};

let game = new Phaser.Game(config);

let player, cursors;
let otherPlayers = {};
let stars = [];
let pokemons = [];
let items = [];
let socketClient;

let messageContainer = document.getElementById('messages');
let chatInput = document.getElementById('chatInput');
let chatSend = document.getElementById('chatSend');

function preload(){
    this.load.image('player', 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png'); // Pikachu
    this.load.image('pokeball', 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
    this.load.image('masterball', 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png');
    this.load.image('ultraball', 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/ultra-ball.png');
    this.load.image('star', 'https://upload.wikimedia.org/wikipedia/commons/2/2f/Star_icon-72a7cf.svg');
}

function create(){
    const self = this;

    // Fundo com estrelas
    for(let i=0;i<50;i++){
        let s = this.add.image(Math.random()*config.width, Math.random()*config.height, 'star');
        s.setScale(Math.random()*0.5 + 0.2);
        stars.push({ sprite:s, speed:Math.random()*0.3+0.1 });
    }

    // Conectar ao Colyseus
    socketClient = new Colyseus.Client('ws://'+window.location.hostname+':2567');

    socketClient.joinOrCreate('game_room').then(room=>{
        console.log('Conectado à sala', room);

        player = self.physics.add.sprite(400,300,'player');

        room.state.players.onAdd = function(playerState, sessionId){
            if(sessionId!==room.sessionId){
                const other = self.physics.add.sprite(playerState.x,playerState.y,'player');
                otherPlayers[sessionId] = other;
            }
        };

        room.state.players.onChange = function(playerState, sessionId){
            if(sessionId!==room.sessionId){
                let other = otherPlayers[sessionId];
                if(other){ other.x=playerState.x; other.y=playerState.y; }
            }
        };

        room.state.players.onRemove = function(playerState, sessionId){
            if(otherPlayers[sessionId]){ otherPlayers[sessionId].destroy(); delete otherPlayers[sessionId]; }
        });

        // Atualizar posição do jogador no servidor
        self.time.addEvent({
            delay:50, loop:true, callback:function(){
                if(player) room.send('move',{x:player.x,y:player.y});
            }
        });

        // Receber mensagens
        room.onMessage('chat', msg=>{
            let el = document.createElement('div');
            el.textContent = msg;
            messageContainer.appendChild(el);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        });
    });

    cursors = this.input.keyboard.createCursorKeys();

    // Pokemons aleatórios no mapa
    for(let i=0;i<5;i++){
        let x = Math.random()*config.width;
        let y = Math.random()*config.height;
        let p = this.physics.add.sprite(x,y,'player');
        pokemons.push(p);
    }

    // Itens espalhados
    for(let i=0;i<3;i++){
        let itemType = ['pokeball','ultraball','masterball'][i%3];
        let x = Math.random()*config.width;
        let y = Math.random()*config.height;
        let it = this.physics.add.sprite(x,y,itemType);
        items.push(it);
    }

    // Chat input
    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', e=>{
        if(e.key==='Enter') sendChat();
    });

    function sendChat(){
        let text = chatInput.value.trim();
        if(!text) return;
        chatInput.value='';
        if(socketClient) socketClient.send('chat',text);
        let el = document.createElement('div');
        el.textContent = 'Você: '+text;
        messageContainer.appendChild(el);
        messageContainer.scrollTop=messageContainer.scrollHeight;
    }
}

function update(){
    // Movimento do jogador
    if(player){
        let speed = 200;
        player.setVelocity(0);
        if(cursors.left.isDown) player.setVelocityX(-speed);
        if(cursors.right.isDown) player.setVelocityX(speed);
        if(cursors.up.isDown) player.setVelocityY(-speed);
        if(cursors.down.isDown) player.setVelocityY(speed);
    }

    // Movimento das estrelas
    stars.forEach(s=>{
        s.sprite.y += s.speed;
        if(s.sprite.y>config.height) s.sprite.y=0;
    });

    // Movimento aleatório dos pokemons
    pokemons.forEach(p=>{
        p.x += (Math.random()-0.5)*2;
        p.y += (Math.random()-0.5)*2;
    });

    // Movimento leve dos itens
    items.forEach(it=>{
        it.x += Math.sin(Date.now()/1000)*0.2;
        it.y += Math.cos(Date.now()/1000)*0.2;
    });
}
</script>
</body>
</html>

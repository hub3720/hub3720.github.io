<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>AN-74 Simulator - Day/Night & Shadows</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: #FFF; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        .info { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; pointer-events: all; }
        button { padding: 12px 20px; cursor: pointer; background: rgba(255,255,255,0.2); color: #FFF; border: 2px solid #FFF; font-weight: bold; backdrop-filter: blur(4px); }
        #joy-wrapper { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid #FFF; pointer-events: all; touch-action: none; }
        #joy-stick { position: absolute; width: 50px; height: 50px; background: #FFF; border-radius: 50%; top: 45px; left: 45px; }
        .thr-box { position: absolute; bottom: 30px; left: 200px; display: flex; flex-direction: column; align-items: center; color: #FFF; }
        input[type=range] { -webkit-appearance: slider-vertical; width: 30px; height: 140px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="info" id="ui-spd">SPEED: 0 kts</div>
        <div class="info" id="ui-alt">ALTITUDE: 0 m</div>
        <div class="info" id="ui-time">TIME: 12:00</div>
    </div>

    <div class="controls">
        <button id="btn-engine">TURN ON</button>
        <button id="btn-rev">REVERSE: OFF</button>
    </div>

    <div class="thr-box"><b>THR</b><input type="range" id="input-thr" min="0" max="1" step="0.01" value="0"></div>
    <div id="joy-wrapper"><div id="joy-stick"></div></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/examples/jsm/loaders/GLTFLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader';

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 2000000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // ATIVA SOMBRAS
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // --- SISTEMA DE DIA E NOITE ---
        const sunPivot = new THREE.Group();
        scene.add(sunPivot);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(0, 5000, 0);
        sunLight.castShadow = true;
        sunLight.shadow.camera.left = -200;
        sunLight.shadow.camera.right = 200;
        sunLight.shadow.camera.top = 200;
        sunLight.shadow.camera.bottom = -200;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunPivot.add(sunLight);

        const ambLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambLight);

        // ESTRELAS
        const starGeo = new THREE.BufferGeometry();
        const starCount = 5000;
        const starPos = new Float32Array(starCount * 3);
        for(let i=0; i<starCount*3; i++) starPos[i] = (Math.random() - 0.5) * 1000000;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xFFFFFF, size: 50}));
        scene.add(stars);

        let airplaneGroup = new THREE.Group();
        let modelContainer = new THREE.Group();
        airplaneGroup.add(modelContainer);

        let speed = 0, isEngine = false, isRev = false, thr = 0, joy = { x: 0, y: 0 }, dayTime = 0;
        const radius = 637000;

        // PLANETA VERDE (Recebe sombra)
        const planet = new THREE.Mesh(new THREE.SphereGeometry(radius, 128, 128), new THREE.MeshStandardMaterial({ color: 0x228B22 }));
        planet.position.y = -radius;
        planet.receiveShadow = true;
        scene.add(planet);

        // PISTA
        const runway = new THREE.Mesh(new THREE.PlaneGeometry(100, 750), new THREE.MeshStandardMaterial({ color: 0x333333 }));
        runway.rotation.x = -Math.PI / 2;
        runway.position.y = 0.15;
        runway.receiveShadow = true;
        scene.add(runway);

        // CARREGAR AN74.GLB (Shadows e Rotação)
        const loader = new GLTFLoader();
        loader.load('an74.glb', (gltf) => { 
            gltf.scene.rotation.y = Math.PI; 
            gltf.scene.traverse(n => { if(n.isMesh) { n.castShadow = true; n.receiveShadow = true; }});
            modelContainer.add(gltf.scene); 
        }, undefined, () => {
            const mock = new THREE.Mesh(new THREE.BoxGeometry(2,1,6), new THREE.MeshStandardMaterial({color: 0xffffff}));
            mock.castShadow = true;
            modelContainer.add(mock);
        });
        scene.add(airplaneGroup);
        airplaneGroup.position.set(0, 0.6, 300);

        // JOYSTICK
        const stick = document.getElementById('joy-stick'), wrap = document.getElementById('joy-wrapper');
        wrap.onpointermove = (e) => {
            if (e.buttons === 1) {
                const r = wrap.getBoundingClientRect();
                joy.x = (e.clientX - r.left - 70) / 70;
                joy.y = (e.clientY - r.top - 70) / 70; 
                joy.x = Math.max(-1, Math.min(1, joy.x));
                joy.y = Math.max(-1, Math.min(1, joy.y));
                stick.style.transform = `translate(${joy.x * 45}px, ${joy.y * 45}px)`;
            }
        };
        wrap.onpointerup = () => { joy = { x: 0, y: 0 }; stick.style.transform = `translate(0,0)`; };

        document.getElementById('btn-engine').onclick = (e) => { isEngine = !isEngine; e.target.innerText = isEngine ? "TURN OFF" : "TURN ON"; };
        document.getElementById('btn-rev').onclick = (e) => { isRev = !isRev; e.target.innerText = isRev ? "REVERSE: ON" : "REVERSE: OFF"; };
        document.getElementById('input-thr').oninput = (e) => thr = parseFloat(e.target.value);

        const clock = new THREE.Clock();
        function loop() {
            const dt = clock.getDelta();
            if (dt > 0.1) return requestAnimationFrame(loop);
            
            // Ciclo Dia/Noite
            dayTime += dt * 0.1; 
            sunPivot.rotation.x = dayTime;
            const sunY = Math.sin(dayTime);
            scene.background = new THREE.Color().setHSL(0.6, 0.5, Math.max(0.05, sunY * 0.5 + 0.2));
            stars.visible = sunY < 0;
            ambLight.intensity = Math.max(0.1, sunY + 0.2);

            const alt = airplaneGroup.position.y;
            const inAir = alt > 1.5;

            let maxCurrent = inAir ? 316 : 160;
            let power = isEngine ? thr * 250 : 0;
            if (isRev && !inAir) power = -thr * 120;
            
            speed += (power - (speed * 0.15)) * dt;
            if (speed > maxCurrent) speed = maxCurrent;
            if (speed < 0) speed = 0;

            if (!inAir) {
                airplaneGroup.position.y = 0.6;
                airplaneGroup.rotation.x = 0; airplaneGroup.rotation.z = 0;
                airplaneGroup.rotation.y -= joy.x * dt * 2;
                if (speed > 150 && joy.y < -0.3) airplaneGroup.position.y += 10 * dt; // Subida forçada inicial
            } else {
                const tRoll = -joy.x * 0.52; 
                const tPitch = -joy.y * 0.8; 
                airplaneGroup.rotation.z = THREE.MathUtils.lerp(airplaneGroup.rotation.z, tRoll, 0.05);
                airplaneGroup.rotation.x = THREE.MathUtils.lerp(airplaneGroup.rotation.x, tPitch, 0.04);
                airplaneGroup.rotation.y -= airplaneGroup.rotation.z * dt * 1.8;

                // Sustentação (Corrigida para subir de verdade)
                const lift = (speed / 130) * (1 - joy.y * 0.8);
                airplaneGroup.position.y += (lift - 1.0) * 60 * dt;
                
                if (speed < 140) { airplaneGroup.rotation.x += 0.3 * dt; airplaneGroup.position.y -= 45 * dt; }
            }

            airplaneGroup.translateZ(speed * dt * 0.85);

            // Câmera e Sombra seguindo o avião
            const camTarget = new THREE.Vector3(0, 10, -35).applyMatrix4(airplaneGroup.matrixWorld);
            camera.position.copy(camTarget);
            camera.lookAt(airplaneGroup.position);
            sunLight.target = airplaneGroup; // Sombra sempre focada no avião

            document.getElementById('ui-spd').innerText = `SPEED: ${Math.round(speed)} kts`;
            document.getElementById('ui-alt').innerText = `ALTITUDE: ${Math.round(alt)} m`;
            document.getElementById('ui-time').innerText = `TIME: ${Math.floor((dayTime % 6.28) * 3.82)}h`;

            renderer.render(scene, camera);
            requestAnimationFrame(loop);
        }
        loop();
        window.onresize = () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
    </script>
</body>
</html>
